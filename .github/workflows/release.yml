name: 3. üèóÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞ (—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫)

on:
  workflow_dispatch:
    inputs:
      release_number:
        description: '–ù–æ–º–µ—Ä —Ä–µ–ª–∏–∑–∞ (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è github.run_number)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
    - name: –ü–æ–ª—É—á–∏—Ç—å –≤–µ—Ç–∫—É —Ä–µ–ª–∏–∑–∞
      uses: actions/checkout@v4

    - name: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: npm ci

    - name: –ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–∏–Ω—Ç–µ—Ä
      run: npm run lint

  test:
    runs-on: ubuntu-latest

    steps:
    - name: –ü–æ–ª—É—á–∏—Ç—å –≤–µ—Ç–∫—É —Ä–µ–ª–∏–∑–∞
      uses: actions/checkout@v4

    - name: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: npm ci

    - name: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
      run: npm test

  typecheck:
    runs-on: ubuntu-latest

    steps:
    - name: –ü–æ–ª—É—á–∏—Ç—å –≤–µ—Ç–∫—É —Ä–µ–ª–∏–∑–∞
      uses: actions/checkout@v4

    - name: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: npm ci

    - name: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–ø—ã
      run: npx tsc --noEmit

  release:
    needs: [lint, test, typecheck]
    runs-on: ubuntu-latest

    steps:
    - name: –ü–æ–ª—É—á–∏—Ç—å –≤–µ—Ç–∫—É —Ä–µ–ª–∏–∑–∞
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: npm ci

    - name: –°–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
      run: npm run build

    - name: –°–æ–∑–¥–∞—Ç—å –≤–µ—Ç–∫—É —Ä–µ–ª–∏–∑–∞
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        RELEASE_NUMBER="${{ github.event.inputs.release_number || github.run_number }}"
        git checkout -b releases/$RELEASE_NUMBER
        git push origin releases/$RELEASE_NUMBER

    - name: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Yandex Container Registry
      uses: docker/login-action@v3
      with:
        registry: cr.yandex
        username: json_key
        password: ${{ secrets.YC_SA_JSON_CREDENTIALS }}

    - name: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: –°–æ–±—Ä–∞—Ç—å –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å Docker –æ–±—Ä–∞–∑
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          cr.yandex/${{ secrets.YC_REGISTRY_ID }}/app:${{ github.event.inputs.release_number || github.run_number }}
          cr.yandex/${{ secrets.YC_REGISTRY_ID }}/app:${{ github.event.inputs.release_number || github.run_number }}_latest
        platforms: linux/amd64

    - name: –°–æ–∑–¥–∞—Ç—å Git —Ç–µ–≥
      run: |
        RELEASE_NUMBER="${{ github.event.inputs.release_number || github.run_number }}"
        git tag $RELEASE_NUMBER
        git push origin $RELEASE_NUMBER

    - name: –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ–≥ —Ä–µ–ª–∏–∑–∞
      id: prev_tag
      run: |
        PREV_TAG=$(git tag --sort=-version:refname | grep -E '^[0-9]+$' | head -2 | tail -1)
        if [ -z "$PREV_TAG" ]; then
          PREV_TAG=$(git rev-list --max-parents=0 HEAD)
        fi
        echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

    - name: –ü–æ–ª—É—á–∏—Ç—å –∫–æ–º–º–∏—Ç—ã —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–µ–ª–∏–∑–∞
      id: commits
      run: |
        COMMITS=$(git log --oneline ${{ steps.prev_tag.outputs.prev_tag }}..${{ github.sha }} --pretty=format:"- %s (%h)")
        echo "commits<<EOF" >> $GITHUB_OUTPUT
        echo "$COMMITS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: –°–æ–∑–¥–∞—Ç—å GitHub Issue
      uses: actions/github-script@v7
      with:
        script: |
          const releaseNumber = '${{ github.event.inputs.release_number || github.run_number }}';
          const { data: issue } = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `–†–µ–ª–∏–∑ ${releaseNumber}`,
            body: `## –†–µ–ª–∏–∑ ${releaseNumber}

            **–î–∞—Ç–∞:** ${new Date().toLocaleString('ru-RU')}
            **–ê–≤—Ç–æ—Ä —Ä–µ–ª–∏–∑–∞:** @${{ github.actor }}
            **–í–µ—Ä—Å–∏—è:** ${releaseNumber}

            ### –ö–æ–º–º–∏—Ç—ã:
            ${{ steps.commits.outputs.commits }}

            ### Docker –æ–±—Ä–∞–∑:
            \`cr.yandex/${{ secrets.YC_REGISTRY_ID }}/app:${releaseNumber}\`

            ### –°—Ç–∞—Ç—É—Å:
            ‚úÖ –†–µ–ª–∏–∑ —Å–æ–∑–¥–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –¥–µ–ø–ª–æ—é
            `,
            labels: ['release', 'deployment']
          });

          console.log('–°–æ–∑–¥–∞–Ω issue #' + issue.number);

    - name: –û–±–Ω–æ–≤–∏—Ç—å CHANGELOG.md
      run: |
        RELEASE_NUMBER="${{ github.event.inputs.release_number || github.run_number }}"
        echo "# Changelog" > temp_changelog.md
        echo "" >> temp_changelog.md
        echo "## [$RELEASE_NUMBER] - $(date +'%Y-%m-%d')" >> temp_changelog.md
        echo "" >> temp_changelog.md
        echo "### –ò–∑–º–µ–Ω–µ–Ω–∏—è:" >> temp_changelog.md
        echo "${{ steps.commits.outputs.commits }}" >> temp_changelog.md
        echo "" >> temp_changelog.md

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ CHANGELOG.md –∏ –Ω–µ –ø—É—Å—Ç–æ–π –ª–∏ –æ–Ω
        if [ -f CHANGELOG.md ] && [ -s CHANGELOG.md ]; then
          # –§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –ø—É—Å—Ç–æ–π
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ä–µ–ª–∏–∑—ã (—Å—Ç—Ä–æ–∫–∏ –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å ##)
          if grep -q "^## \[" CHANGELOG.md; then
            # –ï—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–ª–∏–∑—ã - –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –ø–æ—Å–ª–µ –Ω–æ–≤–æ–≥–æ —Ä–µ–ª–∏–∑–∞
            tail -n +2 CHANGELOG.md >> temp_changelog.md
          else
            # –≠—Ç–æ –±–∞–∑–æ–≤—ã–π CHANGELOG –±–µ–∑ —Ä–µ–ª–∏–∑–æ–≤ - –¥–æ–±–∞–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ—Å–ª–µ –Ω–æ–≤–æ–≥–æ —Ä–µ–ª–∏–∑–∞
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω–æ–µ
            tail -n +2 CHANGELOG.md >> temp_changelog.md
          fi
        else
          # –§–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø—É—Å—Ç–æ–π - –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
          echo "<!-- –ü—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–ª–∏–∑—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å -->" >> temp_changelog.md
        fi

        mv temp_changelog.md CHANGELOG.md

        git add CHANGELOG.md
        git commit -m "–û–±–Ω–æ–≤–∏—Ç—å CHANGELOG.md –¥–ª—è —Ä–µ–ª–∏–∑–∞ $RELEASE_NUMBER"
        git push origin releases/$RELEASE_NUMBER


