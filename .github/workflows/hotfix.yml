name: 4. üîß –•–æ—Ç—Ñ–∏–∫—Å ‚Üí –∑–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å "3. üöÄ –î–µ–ø–ª–æ–π" (—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫)

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: |
          –í–µ—Ä—Å–∏—è —Ä–µ–ª–∏–∑–∞ –¥–ª—è —Ö–æ—Ç—Ñ–∏–∫—Å–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ semver (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1.0.0, 2.1.0)

          üìç –ì–¥–µ –Ω–∞–π—Ç–∏:
          ‚Ä¢ Actions ‚Üí "2. –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞" ‚Üí –≤–µ—Ä—Å–∏—è –ø–æ—Å–ª–µ v
          ‚Ä¢ Issues ‚Üí "–†–µ–ª–∏–∑ v1.0.0" ‚Üí –≤–µ—Ä—Å–∏—è –ø–æ—Å–ª–µ v
          ‚Ä¢ Code ‚Üí Tags ‚Üí –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ–≥ (v1.0.0)
          ‚Ä¢ Releases ‚Üí –≤–µ—Ä—Å–∏—è —Ä–µ–ª–∏–∑–∞

          ‚ö†Ô∏è –•–æ—Ç—Ñ–∏–∫—Å –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ä–µ–ª–∏–∑–æ–≤!
          ‚ö†Ô∏è –£–∫–∞–∑—ã–≤–∞–π—Ç–µ –≤–µ—Ä—Å–∏—é –ë–ï–ó –ø—Ä–µ—Ñ–∏–∫—Å–∞ 'v' (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1.0.0, –∞ –Ω–µ v1.0.0)

          –ü—Ä–∏–º–µ—Ä: 1.0.0
        required: true
        type: string
      hotfix_description:
        description: '–û–ø–∏—Å–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –≤ —Ö–æ—Ç—Ñ–∏–∫—Å–µ (–∫–∞–∫–∏–µ –±–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã)'
        required: false
        type: string
        default: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è'

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
    - name: –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–µ—Ä—Å–∏–∏
      run: |
        VERSION="${{ github.event.inputs.release_version }}"
        if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤–µ—Ä—Å–∏–∏: $VERSION"
          echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: 1.0.0, 2.1.0, etc. (–ë–ï–ó –ø—Ä–µ—Ñ–∏–∫—Å–∞ 'v')"
          exit 1
        fi
        echo "‚úÖ –í–µ—Ä—Å–∏—è $VERSION –≤–∞–ª–∏–¥–Ω–∞"

    - name: –ü–æ–ª—É—á–∏—Ç—å –≤–µ—Ç–∫—É —Ä–µ–ª–∏–∑–∞
      uses: actions/checkout@v4
      with:
        ref: releases/v${{ github.event.inputs.release_version }}

    - name: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: npm ci

    - name: –ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–∏–Ω—Ç–µ—Ä
      run: npm run lint

  typecheck:
    runs-on: ubuntu-latest

    steps:
    - name: –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–µ—Ä—Å–∏–∏
      run: |
        VERSION="${{ github.event.inputs.release_version }}"
        if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤–µ—Ä—Å–∏–∏: $VERSION"
          echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: 1.0.0, 2.1.0, etc. (–ë–ï–ó –ø—Ä–µ—Ñ–∏–∫—Å–∞ 'v')"
          exit 1
        fi
        echo "‚úÖ –í–µ—Ä—Å–∏—è $VERSION –≤–∞–ª–∏–¥–Ω–∞"

    - name: –ü–æ–ª—É—á–∏—Ç—å –≤–µ—Ç–∫—É —Ä–µ–ª–∏–∑–∞
      uses: actions/checkout@v4
      with:
        ref: releases/v${{ github.event.inputs.release_version }}

    - name: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: npm ci

    - name: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–ø—ã
      run: npx tsc --noEmit

  test:
    runs-on: ubuntu-latest

    steps:
    - name: –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–µ—Ä—Å–∏–∏
      run: |
        VERSION="${{ github.event.inputs.release_version }}"
        if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤–µ—Ä—Å–∏–∏: $VERSION"
          echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: 1.0.0, 2.1.0, etc. (–ë–ï–ó –ø—Ä–µ—Ñ–∏–∫—Å–∞ 'v')"
          exit 1
        fi
        echo "‚úÖ –í–µ—Ä—Å–∏—è $VERSION –≤–∞–ª–∏–¥–Ω–∞"

    - name: –ü–æ–ª—É—á–∏—Ç—å –≤–µ—Ç–∫—É —Ä–µ–ª–∏–∑–∞
      uses: actions/checkout@v4
      with:
        ref: releases/v${{ github.event.inputs.release_version }}

    - name: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: npm ci

    - name: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
      run: npm test

  hotfix:
    needs: [lint, typecheck, test]
    runs-on: ubuntu-latest

    steps:
    - name: –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–µ—Ä—Å–∏–∏
      run: |
        VERSION="${{ github.event.inputs.release_version }}"
        if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤–µ—Ä—Å–∏–∏: $VERSION"
          echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: 1.0.0, 2.1.0, etc. (–ë–ï–ó –ø—Ä–µ—Ñ–∏–∫—Å–∞ 'v')"
          exit 1
        fi
        echo "‚úÖ –í–µ—Ä—Å–∏—è $VERSION –≤–∞–ª–∏–¥–Ω–∞"

    - name: –ü–æ–ª—É—á–∏—Ç—å –≤–µ—Ç–∫—É —Ä–µ–ª–∏–∑–∞
      uses: actions/checkout@v4
      with:
        ref: releases/v${{ github.event.inputs.release_version }}
        fetch-depth: 0

    - name: –í—ã—á–∏—Å–ª–∏—Ç—å –≤–µ—Ä—Å–∏—é —Ö–æ—Ç—Ñ–∏–∫—Å–∞
      id: hotfix_version
      run: |
        BASE_VERSION="${{ github.event.inputs.release_version }}"

        # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –Ω–æ–º–µ—Ä —Ö–æ—Ç—Ñ–∏–∫—Å–∞ –¥–ª—è –¥–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏
        LAST_HOTFIX=$(git tag -l "v${BASE_VERSION}-hotfix.*" | sed "s/v${BASE_VERSION}-hotfix\.//" | sort -n | tail -1)

        if [ -z "$LAST_HOTFIX" ]; then
          HOTFIX_NUMBER=1
        else
          HOTFIX_NUMBER=$((LAST_HOTFIX + 1))
        fi

        HOTFIX_VERSION="${BASE_VERSION}-hotfix.${HOTFIX_NUMBER}"
        echo "hotfix_version=$HOTFIX_VERSION" >> $GITHUB_OUTPUT
        echo "hotfix_number=$HOTFIX_NUMBER" >> $GITHUB_OUTPUT
        echo "–í–µ—Ä—Å–∏—è —Ö–æ—Ç—Ñ–∏–∫—Å–∞: v$HOTFIX_VERSION"

    - name: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: npm ci

    - name: –û–±–Ω–æ–≤–∏—Ç—å –≤–µ—Ä—Å–∏—é –≤ package.json
      run: |
        HOTFIX_VERSION="${{ steps.hotfix_version.outputs.hotfix_version }}"
        npm version $HOTFIX_VERSION --no-git-tag-version
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add package.json package-lock.json
        git commit -m "chore: bump version to $HOTFIX_VERSION (hotfix)"

    - name: –°–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
      run: npm run build

    - name: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Yandex Container Registry
      uses: docker/login-action@v3
      with:
        registry: cr.yandex
        username: json_key
        password: ${{ secrets.YC_SA_JSON_CREDENTIALS }}

    - name: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: –°–æ–±—Ä–∞—Ç—å –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å Docker –æ–±—Ä–∞–∑ —Ö–æ—Ç—Ñ–∏–∫—Å–∞
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          cr.yandex/${{ secrets.YC_REGISTRY_ID }}/app:${{ steps.hotfix_version.outputs.hotfix_version }}
          cr.yandex/${{ secrets.YC_REGISTRY_ID }}/app:${{ github.event.inputs.release_version }}-latest
        platforms: linux/amd64

    - name: –°–æ–∑–¥–∞—Ç—å Git —Ç–µ–≥
      run: |
        HOTFIX_VERSION="${{ steps.hotfix_version.outputs.hotfix_version }}"
        git tag v$HOTFIX_VERSION
        git push origin v$HOTFIX_VERSION

    - name: –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ–≥ —Ä–µ–ª–∏–∑–∞/—Ñ–∏–∫—Å–∞
      id: prev_tag
      run: |
        BASE_VERSION="${{ github.event.inputs.release_version }}"

        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç–µ–≥–∏ –¥–ª—è –¥–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ (–≤–∫–ª—é—á–∞—è —Ö–æ—Ç—Ñ–∏–∫—Å—ã) –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –∏—Ö
        PREV_TAG=$(git tag -l "v${BASE_VERSION}*" | grep -E "^v${BASE_VERSION}(-hotfix\.[0-9]+)?$" | sort -V | tail -2 | head -1)

        if [ -z "$PREV_TAG" ]; then
          PREV_TAG="v${BASE_VERSION}"
        fi

        echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
        echo "–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ–≥: $PREV_TAG"

    - name: –ü–æ–ª—É—á–∏—Ç—å –∫–æ–º–º–∏—Ç—ã —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–µ–ª–∏–∑–∞/—Ñ–∏–∫—Å–∞
      id: commits
      run: |
        COMMITS=$(git log --oneline ${{ steps.prev_tag.outputs.prev_tag }}..HEAD --pretty=format:"- %s (%h)")
        echo "commits<<EOF" >> $GITHUB_OUTPUT
        echo "$COMMITS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: –û–±–Ω–æ–≤–∏—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ issues
      uses: actions/github-script@v7
      with:
        script: |
          const baseVersion = '${{ github.event.inputs.release_version }}';
          const hotfixVersion = '${{ steps.hotfix_version.outputs.hotfix_version }}';
          const hotfixNumber = '${{ steps.hotfix_version.outputs.hotfix_number }}';
          const hotfixDescription = '${{ github.event.inputs.hotfix_description }}' || '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è';

          // –ù–∞–π—Ç–∏ issue —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å —Ä–µ–ª–∏–∑–æ–º
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'release',
            state: 'open'
          });

          const releaseIssue = issues.find(issue =>
            issue.title.includes(`–†–µ–ª–∏–∑ v${baseVersion}`)
          );

          if (releaseIssue) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: releaseIssue.number,
              body: `## üîß –•–æ—Ç—Ñ–∏–∫—Å v${hotfixVersion}

              **–î–∞—Ç–∞ —Ñ–∏–∫—Å–∞:** ${new Date().toLocaleString('ru-RU')}
              **–ê–≤—Ç–æ—Ä —Ñ–∏–∫—Å–∞:** @${{ github.actor }}
              **–ù–æ–º–µ—Ä —Ö–æ—Ç—Ñ–∏–∫—Å–∞:** ${hotfixNumber}

              ### üêõ –û–ø–∏—Å–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
              ${hotfixDescription}

              ### üìã –ö–æ–º–º–∏—Ç—ã:
              ${{ steps.commits.outputs.commits }}

              ### üê≥ Docker –æ–±—Ä–∞–∑—ã:
              - \`cr.yandex/${{ secrets.YC_REGISTRY_ID }}/app:${hotfixVersion}\`
              - \`cr.yandex/${{ secrets.YC_REGISTRY_ID }}/app:${baseVersion}-latest\`

              ### ‚úÖ –°—Ç–∞—Ç—É—Å:
              –•–æ—Ç—Ñ–∏–∫—Å —Å–æ–∑–¥–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –¥–µ–ø–ª–æ—é

              **–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ó–∞–ø—É—Å—Ç–∏—Ç–µ "3. üöÄ –î–µ–ø–ª–æ–π –≤ –ø—Ä–æ–¥–∞–∫—à–Ω" —Å –≤–µ—Ä—Å–∏–µ–π \`${baseVersion}\`
              `
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –ª–µ–π–±–ª —Ö–æ—Ç—Ñ–∏–∫—Å–∞
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: releaseIssue.number,
              labels: [`hotfix:${hotfixVersion}`]
            });

            console.log('–û–±–Ω–æ–≤–ª–µ–Ω issue #' + releaseIssue.number);
          } else {
            console.log('–ù–µ –Ω–∞–π–¥–µ–Ω —Å–≤—è–∑–∞–Ω–Ω—ã–π issue –¥–ª—è –≤–µ—Ä—Å–∏–∏ v' + baseVersion);
          }

    - name: –°–æ–∑–¥–∞—Ç—å GitHub Release –¥–ª—è —Ö–æ—Ç—Ñ–∏–∫—Å–∞
      uses: actions/github-script@v7
      with:
        script: |
          const baseVersion = '${{ github.event.inputs.release_version }}';
          const hotfixVersion = '${{ steps.hotfix_version.outputs.hotfix_version }}';
          const hotfixDescription = '${{ github.event.inputs.hotfix_description }}' || '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è';

          await github.rest.repos.createRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag_name: `v${hotfixVersion}`,
            name: `Hotfix v${hotfixVersion}`,
            body: `## –•–æ—Ç—Ñ–∏–∫—Å v${hotfixVersion}

            –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —Ä–µ–ª–∏–∑–∞ v${baseVersion}

            ### üêõ –û–ø–∏—Å–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
            ${hotfixDescription}

            ### üìã –ö–æ–º–º–∏—Ç—ã:
            ${{ steps.commits.outputs.commits }}

            ### üê≥ Docker –æ–±—Ä–∞–∑—ã:
            - \`cr.yandex/${{ secrets.YC_REGISTRY_ID }}/app:${hotfixVersion}\`
            - \`cr.yandex/${{ secrets.YC_REGISTRY_ID }}/app:${baseVersion}-latest\`
            `,
            draft: false,
            prerelease: false
          });

          console.log('–°–æ–∑–¥–∞–Ω GitHub Release v' + hotfixVersion);
